<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking System</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Distributed Banking System - Node {{ node_port }}</h1>
    <p>Current State: {{ state }}</p>

    <h2>Create Account</h2>
    <form action="/create_account" method="post" id="create-account-form">
        <input type="text" name="account_id" placeholder="Account ID" required>
        <input type="number" name="initial_balance" placeholder="Initial Balance" value="0" required>
        <button type="submit">Create Account</button>
    </form>

    <h2>Accounts</h2>
    <ul id="accounts-list">
        {% for account in accounts %}
            <li id="account-{{ account[0] }}">{{ account[0] }}: ${{ account[1] }}</li>
        {% endfor %}
    </ul>

    <h2>Transfer Money</h2>
    <form action="/transfer" method="post" id="transfer-form">
        <input type="text" name="source_account" placeholder="Source Account" required>
        <input type="text" name="target_account" placeholder="Target Account" required>
        <input type="number" name="amount" placeholder="Amount" required>
        <button type="submit">Transfer</button>
    </form>

    <h2>Node Actions</h2>
    <a href="/simulate_failure"><button>Simulate Failure</button></a>
    <a href="/recover"><button>Recover Node</button></a>

    <script>
        // AJAX for creating account
        $('#create-account-form').on('submit', function(e) {
            e.preventDefault();  // Prevent form from submitting the normal way
            $.ajax({
                type: "POST",
                url: "/create_account",
                data: $(this).serialize(),
                success: function(response) {
                    // Update the account list by fetching the updated data
                    fetchAccounts();
                },
                error: function(response) {
                    alert("Error creating account");
                }
            });
        });

        // AJAX for transferring money
        $('#transfer-form').on('submit', function(e) {
            e.preventDefault();  // Prevent form from submitting the normal way
            $.ajax({
                type: "POST",
                url: "/transfer",
                data: $(this).serialize(),
                success: function(response) {
                    // Update the account list by fetching the updated data
                    fetchAccounts();
                },
                error: function(response) {
                    alert("Error during transfer");
                }
            });
        });

        // Fetch updated accounts from the server
        function fetchAccounts() {
            $.ajax({
                url: "/get_accounts",
                method: "GET",
                success: function(response) {
                    var accounts = response.accounts;
                    var accountsList = $('#accounts-list');
                    accountsList.empty(); // Clear the current list

                    // Populate the list with updated data
                    accounts.forEach(function(account) {
                        accountsList.append('<li id="account-' + account[0] + '">' + account[0] + ': $' + account[1] + '</li>');
                    });
                },
                error: function() {
                    alert("Error fetching accounts");
                }
            });
        }

        // Fetch account data initially
        fetchAccounts();
    </script>

</body>
</html>
